{"version":3,"file":"query-params.js","sources":["../../src/services/query-params.ts"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport Service, { inject as service } from '@ember/service';\nimport { isPresent } from '@ember/utils';\nimport { dependencySatisfies, importSync, macroCondition } from '@embroider/macros';\n\nimport * as qs from 'qs';\n\nimport type RouterService from '@ember/routing/router-service';\n\ninterface QueryParams {\n  [key: string]: number | string | QueryParams | qs.ParsedQs[keyof qs.ParsedQs];\n}\n\ninterface QueryParamsByPath {\n  [key: string]: QueryParams;\n}\n\nexport default class QueryParamsService extends Service {\n  @service declare router: RouterService;\n\n  @tracked declare current: QueryParams;\n  @tracked byPath: QueryParamsByPath = {};\n\n  constructor(...args: any[]) {\n    super(...args);\n\n    this.setupProxies();\n    this.updateParams();\n\n    // TODO: drop support for Ember < 3.24 and use @ember/destroyable\n    //       to not cause a memory leak in tests\n    let handler = () => {\n      this.updateParams();\n\n      if (this.router.currentRouteName) {\n        this.updateURL(this.router.currentRouteName);\n      }\n    };\n\n    this.router.on('routeDidChange', handler);\n\n    if (macroCondition(dependencySatisfies('ember-source', '>= 3.24.0'))) {\n      const { registerDestructor } = importSync('@ember/destroyable') as any;\n\n      registerDestructor(this, () => {\n        this.router.off('routeDidChange', handler);\n      });\n    }\n  }\n\n  get pathParts(): [string, string | undefined] {\n    const [path, params] = (this.router.currentURL || '').split('?');\n    const absolutePath = `${path}`.startsWith('/') ? `${path}` : `/${path}`;\n\n    return [absolutePath, params];\n  }\n\n  private setupProxies() {\n    let [path] = this.pathParts;\n\n    this.byPath[path] = this.byPath[path] || {};\n\n    this.current = new Proxy(this.byPath[path], queryParamHandler);\n  }\n\n  private updateParams() {\n    this.setupProxies();\n\n    const [path, params] = this.pathParts;\n    const queryParams = params ? qs.parse(params) : {};\n\n    this.setOnPath(path, queryParams);\n  }\n\n  /**\n   * When we have stored query params for a route\n   * throw them on the URL\n   *\n   */\n  private updateURL(routeName: string) {\n    const path = this.router.urlFor(routeName);\n    const { protocol, host, pathname, search, hash } = window.location;\n    const queryParams = this.byPath[path];\n    const qps = search.split('?')[1];\n    const existing = qs.parse(qps || '');\n    const query = qs.stringify(sortKeys({ ...existing, ...queryParams }));\n    const newUrl = `${protocol}//${host}${pathname}${hash}${isPresent(query) ? '?' : ''}${query}`;\n\n    window.history.replaceState({ path: newUrl }, '', newUrl);\n  }\n\n  private setOnPath(path: string, queryParams: qs.ParsedQs) {\n    this.byPath[path] = this.byPath[path] || {};\n\n    Object.keys(queryParams || {}).forEach((key) => {\n      let value = queryParams[key];\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      let currentValue = this.byPath[path]![key];\n\n      if (currentValue === value) {\n        return;\n      }\n\n      if (value === undefined) {\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n        delete this.byPath[path]![key];\n\n        return;\n      }\n\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      this.byPath[path]![key] = value;\n    });\n  }\n}\n\nfunction sortKeys(unordered: Record<string, unknown>): Record<string, unknown> {\n  return Object.keys(unordered)\n    .sort()\n    .reduce((obj, key) => {\n      obj[key] = unordered[key];\n\n      return obj;\n    }, {} as Record<string, unknown>);\n}\n\nconst queryParamHandler = {\n  get(obj: any, key: string, ...rest: any[]) {\n    return Reflect.get(obj, key, ...rest);\n  },\n  set(obj: any, key: string, value: any, ...rest: any[]) {\n    let { protocol, host, pathname } = window.location;\n    let query = qs.stringify(sortKeys({ ...obj, [key]: value }));\n    let newUrl = `${protocol}//${host}${pathname}${isPresent(query) ? '?' : ''}${query}`;\n\n    window.history.pushState({ path: newUrl }, '', newUrl);\n\n    return Reflect.set(obj, key, value, ...rest);\n  },\n};\n\n// DO NOT DELETE: this is how TypeScript knows how to look up your services.\ndeclare module '@ember/service' {\n  interface Registry {\n    'query-params': QueryParams;\n  }\n}\n"],"names":["QueryParamsService","_class","Service","constructor","args","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","setupProxies","updateParams","handler","router","currentRouteName","updateURL","on","macroCondition","dependencySatisfies","registerDestructor","importSync","off","pathParts","path","params","currentURL","split","absolutePath","startsWith","byPath","current","Proxy","queryParamHandler","queryParams","qs","parse","setOnPath","routeName","urlFor","protocol","host","pathname","search","hash","window","location","qps","existing","query","stringify","sortKeys","newUrl","isPresent","history","replaceState","Object","keys","forEach","key","value","currentValue","undefined","_applyDecoratedDescriptor","prototype","service","configurable","enumerable","writable","initializer","tracked","unordered","sort","reduce","obj","get","rest","Reflect","set","pushState"],"mappings":"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"}